<?php
/**
 * @let CrimsonAgility\ProductsRange\Block\ProductsRange $block
 */
$text = $block->getText();
try {
    $currency = $block->getStoreCurrency();
} catch (\Magento\Framework\Exception\NoSuchEntityException $e) {
    $currency = "";
}
?>
<div class="row">
    <div class ="mp-col-md-8" >
        <div class = "row">
            <form method="post" action="" id="search-products-form" >
                <div class="field">
                    <label for="input1" class="label"><span><?php echo __('Low Price') ?></span></label>
                    <div class="control">
                        <input name="lowPrice" id="input1" title="<?php echo __('Low price') ?>" value="" class="input-text" type="text" required>
                    </div>
                </div>
                <div class="field">
                    <label for="input2" class="label"><span><?php echo __('High Price') ?></span></label>
                    <div class="control">
                        <input name="highPrice" id="input2" title="<?php echo __('High Price') ?>" value="" class="input-text" type="text" required>
                    </div>
                </div>
                <div class="field">
                    <label for="input3" class="label"><span><?php echo __('Sort By price') ?></span></label>
                    <div class="control">
                        <select name="sorting" id="input3" title="sort" required>
                            <option value="ascending">Ascending</option>
                            <option value="descending">Descending</option>
                        </select>
                    </div>
                </div>
                <div class="actions-toolbar">
                    <div class="primary">
                        <button type="button" class="action submit primary" id="submit-btn" title="<?php echo __('Submit') ?>">
                            <span><?php echo __('Submit') ?></span>
                        </button>
                    </div>
                </div>
            </form>
        </div>
        <br/>
        <div id="label-loading" style="display: none"><h3> Loading... </h3></div>
        <div id="label-validateData" style="display: none"></div>
        <div id="label-noresponse" style="display: none"><h3> Not Products found in this Range </h3></div>
        <table id="main-table" style="display: none">
            <thead>
            <tr>
                <th>Thumbnail</th>
                <th>SKU</th>
                <th>Name</th>
                <th>Quantity</th>
                <th>Price (<?=__($currency)?>)</th>
                <th>URL</th>
            </tr>
            </thead>
            <tbody  id="main-table-body">
            </tbody>
        </table>

    </div>
    <br>
</div>
<script >
    require([
        'jquery',
        'mage/url',
    ], function ($, url) {
        $('#submit-btn').click(function (event) {
            let actionUrl = url.build('rest/V1/products/search');
            let payload = {
                "lowPrice": $("#input1").val(),
                "highPrice": $("#input2").val(),
                "sorting": $("#input3").val()
            };
            $("#label-validateData").empty();
            $("#label-validateData").css("display", "none");
            if(checkIfFormIsValid()){
                event.preventDefault();
                $.ajax({
                    url: actionUrl,
                    data: JSON.stringify(payload),
                    type: 'POST',
                    contentType: 'application/json',
                    processData: false,
                    beforeSend: function () {
                        $("#label-loading").css("display", "block");
                        $("#main-table").css("display", "none");
                        $("#label-noresponse").css("display", "none");
                        $("#main-table-body").empty();
                    },
                    success: function (response) {
                        displayproductsTable(response);
                    },
                    error: function (response) {
                        data = response.responseJSON
                        if(data.message === "Parameter Validation Failed"){
                            $('#label-loading').append('<h3> Invalid Range Params, please try with different inputs </h3>');
                        }
                        else {
                            $('#label-loading').append('<h3> There is a problem in our website, please try again later. </h3>');
                        }
                    },
                });
            }
    });

        function checkIfFormIsValid(){
            $("#main-table").css("display", "none");
            $("#label-validateData").css("display", "block");
           let lowPrice =  $("#input1").val();
           let highPrice =  $("#input2").val();
            if(highPrice === '' || lowPrice === ''){
                $('#label-validateData').append('<h3> Fields cannot be empty </h3>');
                return false
            }
           else if(lowPrice < 0){
               $('#label-validateData').append('<h3> Low Price cannot be negative  </h3>');
               return false
           }else if(highPrice > 5*lowPrice){
               $('#label-validateData').append('<h3> High Price cannot be 5 times greater than low price  </h3>');
               return false
           }else if(Number(lowPrice) > Number(highPrice)){
               $('#label-validateData').append('<h3> Low Price cannot be greater than highPrice </h3>');
               return false
           }
            $('#label-validateData').css("display", "none");
            return true;
        }

        function displayproductsTable(products){
            $("#label-loading").css("display", "none");
            if(products.length === 0) {
                $("#label-noresponse").css("display", "block");
            } else {
                $("#main-table").css("display", "block");
                $("#label-noresponse").css("display", "none");
                for (let product of products) {
                    let sku_string = '<td class="row sku">' + product.sku + '</td>';
                    let name_string = '<td class="row name">' + product.name + '</td>';
                    let thumbnail_string = '<td class="row name">' + 'Foto' + '</td>';
                    let price_string = '<td class="row name">' + product.price + '</td>';
                    let url_string = '<td class="row name">' + '<a  href=' + product.url + '> Product page </a> </td>';
                    let qty_string = '<td class="row name">' + product.qty + '</td>';
                    let sku = $(sku_string);
                    let name = $(name_string);
                    let thumbnail = $(thumbnail_string);
                    let price = $(price_string);
                    let url = $(url_string);
                    let qty = $(qty_string);

                    let tr_1 = $('<tr>');
                    let tr_2 =  $('</tr>');
                    $('#main-table-body').append(tr_1);
                    $('#main-table-body').append(thumbnail);
                    $('#main-table-body').append(sku);
                    $('#main-table-body').append(name);
                    $('#main-table-body').append(qty);
                    $('#main-table-body').append(price);
                    $('#main-table-body').append(url);
                    $('#main-table-body').append(tr_2);
                }
            }
        }

    })

</script>
